{% extends "base.html" %}
{% block title %}記録の確認{% endblock %}
{% block content %}
<div class="container mt-4">
  <h3 class="mb-4">記録の確認</h3>

  <div class="card shadow-sm p-3 mb-4">
    <div class="card-body">
      <p><strong>咀嚼回数:</strong> <span id="stat-chew"></span></p>
      <p><strong>経過時間:</strong> <span id="stat-time"></span> 秒</p>
      <p><strong>ペース:</strong> <span id="stat-pace"></span></p>
      <hr>
      <h5 class="mt-3">算出されたスコア: <span id="score-value"></span></h5>
    </div>
  </div>

  <div class="d-flex justify-content-center gap-3">
    <button id="saveBtn" class="btn btn-primary btn-lg">記録を保存</button>
    <button id="discardBtn" class="btn btn-outline-secondary btn-lg">破棄</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const stats = JSON.parse(localStorage.getItem("latestStats") || "{}");
  if (!stats.chewCount && !stats.elapsedTime && !stats.pace) {
    document.querySelector(".container").innerHTML = `
      <div class="alert alert-warning mt-4">記録データがありません。</div>
      <a href="{{ url_for('index') }}" class="btn btn-secondary mt-3">戻る</a>
    `;
    return;
  }

  // 表示
  document.getElementById("stat-chew").textContent = stats.chewCount;
  document.getElementById("stat-time").textContent = stats.elapsedTime.toFixed(1);
  document.getElementById("stat-pace").textContent = stats.pace.toFixed(2);

  // スコア計算（サーバと一致する式を使用）
  const value = Math.round(stats.chewCount * stats.pace);
  document.getElementById("score-value").textContent = value;

  // 保存ボタン
  document.getElementById("saveBtn").addEventListener("click", async () => {
    const res = await fetch("/result", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(stats),
    });

    if (res.ok) {
      localStorage.removeItem("latestStats");
      window.location.href = "/history";
    } else {
      alert("記録の保存に失敗しました。");
    }
  });

  // 破棄ボタン
  document.getElementById("discardBtn").addEventListener("click", () => {
    localStorage.removeItem("latestStats");
    window.location.href = "/index";
  });
});
</script>
{% endblock %}